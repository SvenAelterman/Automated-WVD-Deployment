{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "dj_adminAccount": {
            "type": "string"
        },
        "dj_adminAccountPassword": {
            "type": "securestring"
        },
        "va_domainFQDN": {
            "type": "string"
        },
        "va_dnsServers": {
            "type": "string"
        },
        "va_cloudResourcePrefix": {
            "type": "string"
        },
        "va_organizationalUnit": {
            "type": "string"
        },
        "va_adSiteName": {
            "type": "string"
        },
        "vn_virtualNetworkResourceGroupName": {
            "type": "string"
        },
        "vn_virtualNetworkName": {
            "type": "string"
        },
        "anf_netAppAccountName": {
            "type": "string"
        },
        "anf_netAppCapacityPoolName": {
            "type": "string"
        },
        "anf_netAppVolumeCount": {
            "type": "int"
        },
        "anf_netAppVolumeName": {
            "type": "string"
        },
        "anf_delegatedSubnetName": {
            "type": "string"
        }
    },
    "variables": {
        "vNetId": "[resourceId(parameters('vn_virtualNetworkResourceGroupName'),'Microsoft.Network/virtualNetworks',parameters('vn_virtualNetworkName'))]"
    },
    "resources": [
        {
            "type": "Microsoft.NetApp/netAppAccounts/capacityPools/volumes",
            "apiVersion": "2019-11-01",
            "name": "[concat(parameters('anf_netAppAccountName'),'/',parameters('anf_netAppCapacityPoolName'),'/',concat(parameters('anf_netAppVolumeName'),padLeft(copyIndex(1),2,'0')))]",
            "location": "[resourceGroup().location]",
            "copy": {
                "name": "ANF-Volume-Loop",
                "count": "[parameters('anf_netAppVolumeCount')]"
            },
            "dependsOn": [
                "[resourceId(resourceGroup().name,'Microsoft.NetApp/netAppAccounts/capacityPools', parameters('anf_netAppAccountName'),parameters('anf_netAppCapacityPoolName'))]"
            ],
            "properties": {
                "serviceLevel": "Premium",
                "creationToken": "[concat(parameters('anf_netAppVolumeName'),padLeft(copyIndex(1),2,'0'))]",
                //usageThreshold value must be a multiple of 1099511627776 (e.g. 1099511627776 * 31 = 31TiB)
                "usageThreshold": 34084860461056,
                "exportPolicy": {
                    "rules": [
                    ]
                },
                "protocolTypes": [
                    "CIFS"
                ],
                "subnetId": "[concat(variables('vNetId'),'/subnets/',parameters('anf_delegatedSubnetName'))]"
            }
        },
        {
            "type": "Microsoft.NetApp/netAppAccounts/capacityPools",
            "apiVersion": "2019-11-01",
            "name": "[concat(parameters('anf_netAppAccountName'),'/',parameters('anf_netAppCapacityPoolName'))]",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[resourceId(resourceGroup().name,'Microsoft.NetApp/netAppAccounts',parameters('anf_netAppAccountName'))]"
            ],
            "properties": {
                "serviceLevel": "Premium",
                //size value must be a multiple of 1099511627776 (e.g. 35184372088832 * 32 = 32TiB)
                "size": 35184372088832
            },
            "resources": [
                
            ]
        },
        {
            "name": "[parameters('anf_netAppAccountName')]",
            "type": "Microsoft.NetApp/netAppAccounts",
            "apiVersion": "2019-07-01",
            "location": "[resourceGroup().location]",
            "properties": {
                "activeDirectories": [
                    {
                        "username": "[parameters('dj_adminAccount')]",
                        "password": "[parameters('dj_adminAccountPassword')]",
                        "domain": "[parameters('va_domainFQDN')]",
                        "dns": "[parameters('va_dnsServers')]",
                        "smbServerName": "[concat(parameters('va_cloudResourcePrefix'),'hsm01')]",
                        "organizationalUnit": "[parameters('va_organizationalUnit')]",
                        "site": "[parameters('va_adSiteName')]"
                    }
                ]
            }
        }
    ]
}